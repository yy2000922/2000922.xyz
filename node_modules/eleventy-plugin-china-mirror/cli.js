#!/usr/bin/env node

/**
 * CLI tool for creating Eleventy projects with China Mirror pre-configured
 */

import { writeFileSync, existsSync } from 'node:fs';
import { join } from 'node:path';
import { fileURLToPath } from 'node:url';

const CONFIG = {
  logPrefix: '[create-eleventy-china]'
};

function createEleventyConfig() {
  return `import chinaMirror from 'eleventy-plugin-china-mirror';

export default function(eleventyConfig) {
  // Add China Mirror plugin for network acceleration
  eleventyConfig.addPlugin(chinaMirror);

  // Basic Eleventy configuration
  return {
    dir: {
      input: 'src',
      output: 'dist'
    }
  };
}`;
}

function createPackageJson(projectName) {
  return {
    name: projectName,
    version: "1.0.0",
    description: "Eleventy project with China Mirror acceleration",
    scripts: {
      build: "eleventy",
      serve: "eleventy --serve",
      start: "eleventy --serve"
    },
    devDependencies: {
      "@11ty/eleventy": "^2.0.0",
      "eleventy-plugin-china-mirror": "^1.0.0"
    },
    type: "module"
  };
}

function createSampleIndex() {
  return `<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Eleventy China Mirror Demo</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 2rem;
            line-height: 1.6;
        }
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 2rem;
            border-radius: 8px;
            margin-bottom: 2rem;
        }
        .feature {
            background: #f8f9fa;
            padding: 1rem;
            margin: 1rem 0;
            border-left: 4px solid #667eea;
        }
        .success {
            color: #28a745;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>ğŸš€ Eleventy China Mirror</h1>
        <p>ä¸­å›½ç½‘ç»œåŠ é€Ÿæ’ä»¶å·²ç”Ÿæ•ˆï¼</p>
    </div>

    <h2>âœ¨ åŠŸèƒ½ç‰¹æ€§</h2>
    <div class="feature">
        <h3>1. ä¾èµ–ä¸‹è½½åŠ é€Ÿ</h3>
        <p>sharpã€libvips ç­‰äºŒè¿›åˆ¶ä¾èµ–å°†é€šè¿‡å›½å†…é•œåƒä¸‹è½½</p>
        <p class="success">âœ“ å·²é…ç½® npm ä¸­å›½é•œåƒ</p>
    </div>

    <div class="feature">
        <h3>2. CDN è¯·æ±‚åŠ é€Ÿ</h3>
        <p>cdn.11ty.dev è¯·æ±‚å°†è‡ªåŠ¨è·¯ç”±åˆ°å›½å†…é•œåƒ</p>
        <p class="success">âœ“ å·²å¯ç”¨ fetch æ‹¦æˆªå™¨</p>
    </div>

    <div class="feature">
        <h3>3. é›¶é…ç½®ä½¿ç”¨</h3>
        <p>æ— éœ€æ‰‹åŠ¨ä¿®æ”¹é…ç½®æ–‡ä»¶ï¼Œå³æ’å³ç”¨</p>
        <p class="success">âœ“ æ’ä»¶å·²è‡ªåŠ¨é…ç½®</p>
    </div>
</body>
</html>`;
}

function main() {
  const args = process.argv.slice(2);
  const projectName = args[0] || 'eleventy-china-project';
  
  console.log(`${CONFIG.logPrefix} Creating Eleventy project with China Mirror: ${projectName}`);
  
  try {
    // Create project directory
    const projectPath = join(process.cwd(), projectName);
    
    if (existsSync(projectPath)) {
      console.error(`${CONFIG.logPrefix} Error: Directory ${projectName} already exists`);
      process.exit(1);
    }
    
    // Create basic project structure
    const fs = await import('node:fs/promises');
    await fs.mkdir(projectPath, { recursive: true });
    await fs.mkdir(join(projectPath, 'src'), { recursive: true });
    
    // Write configuration files
    writeFileSync(join(projectPath, 'eleventy.config.js'), createEleventyConfig());
    writeFileSync(join(projectPath, 'package.json'), JSON.stringify(createPackageJson(projectName), null, 2));
    writeFileSync(join(projectPath, 'src', 'index.html'), createSampleIndex());
    
    console.log(`${CONFIG.logPrefix} Project created successfully!`);
    console.log(`${CONFIG.logPrefix} Next steps:`);
    console.log(`${CONFIG.logPrefix}   1. cd ${projectName}`);
    console.log(`${CONFIG.logPrefix}   2. npm install`);
    console.log(`${CONFIG.logPrefix}   3. npm start`);
    
  } catch (error) {
    console.error(`${CONFIG.logPrefix} Error creating project:`, error.message);
    process.exit(1);
  }
}

main();

