# Eleventy Plugin China Mirror

ðŸš€ Zero-configuration China network acceleration plugin for Eleventy

[English](#english) | [ä¸­æ–‡](#ä¸­æ–‡)

## English

### Features

- **ðŸŽ¯ Zero Configuration**: Works out of the box with no manual setup required
- **âš¡ Dependency Acceleration**: Automatically configures npm to use Chinese mirrors for sharp, libvips, and other large binaries
- **ðŸŒ CDN Acceleration**: Intercepts fetch requests to `cdn.11ty.dev` and routes them through Chinese mirrors
- **ðŸ”§ Seamless Integration**: Simply add the plugin to your Eleventy config
- **ðŸ“ˆ Performance Boost**: Typically 5-10x faster downloads for dependencies

### Installation

```bash
npm install eleventy-plugin-china-mirror --save-dev
```

### Usage

Add to your `eleventy.config.js`:

```javascript
import chinaMirror from 'eleventy-plugin-china-mirror';

export default function(eleventyConfig) {
  eleventyConfig.addPlugin(chinaMirror);
  
  // Your other configurations...
};
```

That's it! The plugin will automatically:

1. Create a `.npmrc` file with Chinese mirror configurations (if one doesn't exist)
2. Intercept fetch requests to CDN and route them through mirrors
3. Log all activities to the console for transparency

### Online Try (RunKit)

[![Try eleventy-plugin-china-mirror on RunKit](https://badge.runkitcdn.com/eleventy-plugin-china-mirror.svg)](https://runkit.com/npm/eleventy-plugin-china-mirror)

RunKit uses CommonJS by default. Use this snippet:

```js
const chinaMirror = require("eleventy-plugin-china-mirror");

// Minimal Eleventy-like config object
const mockConfig = { addPlugin: () => {} };
chinaMirror(mockConfig, {});

// Optional: test fetch interception (if fetch is available)
(async () => {
  if (typeof fetch === 'function') {
    const res = await fetch('https://cdn.11ty.dev/img/logo.png');
    console.log('status:', res.status, 'url:', res.url);
  } else {
    console.log('fetch not available on this RunKit runtime; interceptor installed but request skipped');
  }
})();
```

### CLI Scaffold (Optional)

Create a new Eleventy project with the plugin pre-configured:

```bash
npm create eleventy-china@latest my-project
cd my-project
npm install
npm start
```

### How It Works

#### NPM Registry Configuration

The plugin automatically creates a `.npmrc` file with:

```
registry=https://registry.npmmirror.com
sharp_binary_host=https://npmmirror.com/mirrors/sharp
sharp_libvips_binary_host=https://npmmirror.com/mirrors/sharp-libvips
disturl=https://npmmirror.com/mirrors/node
```

#### Fetch Request Interception

The plugin patches the global `fetch` function to replace:
- `https://cdn.11ty.dev/*` â†’ `https://registry.npmmirror.com/11ty-cdn/*`

If the mirror fails, it automatically falls back to the original URL.

### Performance Improvements

| Scenario | Before | After |
|----------|--------|-------|
| Sharp download | 5-10 minutes | < 1 minute |
| CDN requests | 200-500ms | 30-50ms |
| npm install | 3-5 minutes | < 1 minute |

### Compatibility

- Eleventy â‰¥ 2.0
- Node.js â‰¥ 16
- Supports both ESM and CommonJS

### Security

- Only modifies whitelisted domains (`cdn.11ty.dev`)
- Never overwrites existing `.npmrc` files
- Falls back to original URLs if mirrors fail
- Open source with MIT license

---

## ä¸­æ–‡

### åŠŸèƒ½ç‰¹æ€§

- **ðŸŽ¯ é›¶é…ç½®**: å¼€ç®±å³ç”¨ï¼Œæ— éœ€æ‰‹åŠ¨è®¾ç½®
- **âš¡ ä¾èµ–åŠ é€Ÿ**: è‡ªåŠ¨é…ç½® npm ä½¿ç”¨å›½å†…é•œåƒä¸‹è½½ sharpã€libvips ç­‰å¤§åž‹äºŒè¿›åˆ¶æ–‡ä»¶
- **ðŸŒ CDN åŠ é€Ÿ**: æ‹¦æˆªå¯¹ `cdn.11ty.dev` çš„è¯·æ±‚å¹¶è·¯ç”±åˆ°å›½å†…é•œåƒ
- **ðŸ”§ æ— ç¼é›†æˆ**: åªéœ€åœ¨ Eleventy é…ç½®ä¸­æ·»åŠ æ’ä»¶
- **ðŸ“ˆ æ€§èƒ½æå‡**: ä¾èµ–ä¸‹è½½é€Ÿåº¦é€šå¸¸æå‡ 5-10 å€

### å®‰è£…

```bash
npm install eleventy-plugin-china-mirror --save-dev
```

### ä½¿ç”¨æ–¹æ³•

æ·»åŠ åˆ° `eleventy.config.js`ï¼š

```javascript
import chinaMirror from 'eleventy-plugin-china-mirror';

export default function(eleventyConfig) {
  eleventyConfig.addPlugin(chinaMirror);
  
  // å…¶ä»–é…ç½®...
};
```

å°±è¿™ä¹ˆç®€å•ï¼æ’ä»¶ä¼šè‡ªåŠ¨ï¼š

1. åˆ›å»º `.npmrc` æ–‡ä»¶å¹¶é…ç½®å›½å†…é•œåƒï¼ˆå¦‚æžœä¸å­˜åœ¨ï¼‰
2. æ‹¦æˆª CDN è¯·æ±‚å¹¶é€šè¿‡é•œåƒè·¯ç”±
3. å°†æ‰€æœ‰æ´»åŠ¨è®°å½•åˆ°æŽ§åˆ¶å°ä»¥ç¡®ä¿é€æ˜Žæ€§

### CLI è„šæ‰‹æž¶ï¼ˆå¯é€‰ï¼‰

åˆ›å»ºå·²é¢„é…ç½®æ’ä»¶çš„æ–° Eleventy é¡¹ç›®ï¼š

```bash
npm create eleventy-china@latest my-project
cd my-project
npm install
npm start
```

### å·¥ä½œåŽŸç†

#### NPM æ³¨å†Œè¡¨é…ç½®

æ’ä»¶è‡ªåŠ¨åˆ›å»º `.npmrc` æ–‡ä»¶ï¼š

```
registry=https://registry.npmmirror.com
sharp_binary_host=https://npmmirror.com/mirrors/sharp
sharp_libvips_binary_host=https://npmmirror.com/mirrors/sharp-libvips
disturl=https://npmmirror.com/mirrors/node
```

#### è¯·æ±‚æ‹¦æˆª

æ’ä»¶ä¿®æ”¹å…¨å±€ `fetch` å‡½æ•°ï¼š
- `https://cdn.11ty.dev/*` â†’ `https://registry.npmmirror.com/11ty-cdn/*`

å¦‚æžœé•œåƒå¤±è´¥ï¼Œè‡ªåŠ¨å›žé€€åˆ°åŽŸå§‹ URLã€‚

### æ€§èƒ½å¯¹æ¯”

| åœºæ™¯ | ä½¿ç”¨å‰ | ä½¿ç”¨åŽ |
|------|--------|--------|
| Sharp ä¸‹è½½ | 5-10 åˆ†é’Ÿ | < 1 åˆ†é’Ÿ |
| CDN è¯·æ±‚ | 200-500ms | 30-50ms |
| npm å®‰è£… | 3-5 åˆ†é’Ÿ | < 1 åˆ†é’Ÿ |

### å…¼å®¹æ€§

- Eleventy â‰¥ 2.0
- Node.js â‰¥ 16
- æ”¯æŒ ESM å’Œ CommonJS

### å®‰å…¨æ€§

- ä»…ä¿®æ”¹ç™½åå•åŸŸå (`cdn.11ty.dev`)
- ä»Žä¸è¦†ç›–çŽ°æœ‰çš„ `.npmrc` æ–‡ä»¶
- é•œåƒå¤±è´¥æ—¶å›žé€€åˆ°åŽŸå§‹ URL
- å¼€æº MIT è®¸å¯è¯

### License

MIT Â© Eleventy China Mirror Team

